{% extends "layout.html" %}

{% block title %}Live Eye Tracking{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="mb-4">Live Eye Tracking</h1>
        <p class="lead">Monitor your eye health in real-time. Track your blink rate and detect signs of drowsiness.</p>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-camera-video"></i> Camera Feed</span>
                    <span class="badge bg-success tracking-status">Tracking Active</span>
                </div>
            </div>
            <div class="card-body">
                <div class="camera-feed-wrapper" style="position: relative; background-color: #000; height: 480px; border-radius: 10px; overflow: hidden;">
                    <!-- Simulated camera feed showing eye detection -->
                    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNk+A8AAQUBAScY42YAAAAASUVORK5CYII=" class="img-fluid" style="width: 100%; height: 100%; object-fit: cover; opacity: 0.7;" />
                    
                    <!-- Overlay UI for eye tracking -->
                    <div class="detection-overlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;">
                        <!-- Simulated face detection rectangle -->
                        <div class="face-rect" style="position: absolute; top: 120px; left: 240px; width: 320px; height: 320px; border: 2px solid #3a86ff; border-radius: 10px;"></div>
                        
                        <!-- Simulated left eye detection -->
                        <div class="eye-rect left" style="position: absolute; top: 220px; left: 300px; width: 60px; height: 30px; border: 2px solid #ff006e; border-radius: 5px;"></div>
                        
                        <!-- Simulated right eye detection -->
                        <div class="eye-rect right" style="position: absolute; top: 220px; left: 440px; width: 60px; height: 30px; border: 2px solid #ff006e; border-radius: 5px;"></div>
                        
                        <!-- Simulated blink status text -->
                        <div class="blink-status" style="position: absolute; top: 50px; left: 50px; color: white; background-color: rgba(0,0,0,0.5); padding: 10px; border-radius: 5px;">
                            Blink Rate: <span class="blink-value">17</span> bpm
                        </div>
                        
                        <!-- Simulated drowsiness status text -->
                        <div class="drowsiness-status" style="position: absolute; top: 50px; right: 50px; color: white; background-color: rgba(0,0,0,0.5); padding: 10px; border-radius: 5px;">
                            Drowsiness: <span class="drowsiness-value">32%</span>
                        </div>
                    </div>
                </div>
                
                <div class="d-grid gap-2 d-md-flex justify-content-md-between mt-3">
                    <button class="btn btn-primary tracking-toggle">
                        <i class="bi bi-pause-circle"></i> Pause Tracking
                    </button>
                    <div class="btn-group" role="group">
                        <button class="btn btn-outline-secondary">
                            <i class="bi bi-camera"></i> Take Screenshot
                        </button>
                        <button class="btn btn-outline-secondary">
                            <i class="bi bi-sliders"></i> Adjust Sensitivity
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-eye"></i> Eye Metrics
            </div>
            <div class="card-body">
                <ul class="list-group list-group-flush">
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        Blink Rate
                        <span class="badge bg-primary rounded-pill">17 bpm</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        Blink Duration
                        <span class="badge bg-primary rounded-pill">210 ms</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        Drowsiness Level
                        <span class="badge bg-success rounded-pill">32%</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        PERCLOS
                        <span class="badge bg-primary rounded-pill">18%</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        Session Duration
                        <span class="badge bg-secondary rounded-pill">12:45</span>
                    </li>
                </ul>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <i class="bi bi-bell"></i> Active Monitoring
            </div>
            <div class="card-body">
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="drowsinessAlerts" checked>
                    <label class="form-check-label" for="drowsinessAlerts">Drowsiness Alerts</label>
                </div>
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="blinkRateMonitoring" checked>
                    <label class="form-check-label" for="blinkRateMonitoring">Blink Rate Monitoring</label>
                </div>
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="breakReminders" checked>
                    <label class="form-check-label" for="breakReminders">Break Reminders</label>
                </div>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="gazeTracking">
                    <label class="form-check-label" for="gazeTracking">Gaze Tracking</label>
                </div>
                
                <hr>
                
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> Look directly at the camera for best detection results.
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Simulate blinking eyes in the UI
    function simulateBlinking() {
        const leftEye = document.querySelector('.eye-rect.left');
        const rightEye = document.querySelector('.eye-rect.right');
        
        setInterval(() => {
            // Randomly blink eyes (close them briefly)
            if (Math.random() < 0.1) {  // 10% chance of blinking
                leftEye.style.height = '3px';
                rightEye.style.height = '3px';
                
                // Reopen eyes after a short delay
                setTimeout(() => {
                    leftEye.style.height = '30px';
                    rightEye.style.height = '30px';
                }, 200);
            }
        }, 1000);
    }
    
    // Simulate changing metrics
    function simulateMetricsChange() {
        const blinkValue = document.querySelector('.blink-value');
        const drowsinessValue = document.querySelector('.drowsiness-value');
        
        setInterval(() => {
            // Update blink rate with small random variations
            const currentBlink = parseInt(blinkValue.textContent);
            const newBlink = Math.max(10, Math.min(25, currentBlink + (Math.random() > 0.5 ? 1 : -1)));
            blinkValue.textContent = newBlink;
            
            // Update drowsiness with small random variations
            const currentDrowsiness = parseInt(drowsinessValue.textContent);
            const newDrowsiness = Math.max(5, Math.min(95, currentDrowsiness + (Math.random() > 0.7 ? 2 : -1)));
            drowsinessValue.textContent = newDrowsiness + '%';
            
            // Update drowsiness color based on level
            if (newDrowsiness > 70) {
                drowsinessValue.parentElement.style.backgroundColor = 'rgba(220, 53, 69, 0.8)';
            } else if (newDrowsiness > 50) {
                drowsinessValue.parentElement.style.backgroundColor = 'rgba(255, 193, 7, 0.8)';
            } else {
                drowsinessValue.parentElement.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            }
        }, 3000);
    }
    
    // Handle tracking toggle button
    document.querySelector('.tracking-toggle').addEventListener('click', function() {
        const isTracking = this.innerHTML.includes('Pause');
        const statusBadge = document.querySelector('.tracking-status');
        
        if (isTracking) {
            this.innerHTML = '<i class="bi bi-play-circle"></i> Resume Tracking';
            statusBadge.className = 'badge bg-warning tracking-status';
            statusBadge.textContent = 'Tracking Paused';
        } else {
            this.innerHTML = '<i class="bi bi-pause-circle"></i> Pause Tracking';
            statusBadge.className = 'badge bg-success tracking-status';
            statusBadge.textContent = 'Tracking Active';
        }
    });
    
    // Initialize simulations when page loads
    document.addEventListener('DOMContentLoaded', function() {
        simulateBlinking();
        simulateMetricsChange();
    });
</script>
{% endblock %}